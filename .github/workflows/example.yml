name: Example Plugin Build

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    name: Build and Attest Plugin
    uses: ./.github/workflows/buildv2.yml
    with:
      plugin-directory: example-plugin
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write

  validate:
    name: Validate Build
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
      attestations: read
    steps:
      - uses: oras-project/setup-oras@v1
      - uses: actions/checkout@v5
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - name: Verify provenance attestation
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "### 🔒 Dragonglass Plugin Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Use our dragonglass CLI to verify the plugin
          echo "🚀 **Verifying plugin with Dragonglass CLI**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Run dragonglass verify command with verbose output
          if go run ./cmd/dragonglass verify \
            --trusted-builder="https://github.com/gillisandrew/dragonglass-poc/.github/workflows/buildv2.yml@refs/heads/main" \
            --verbose \
            "oci://${{ needs.build.outputs.subject-name }}"; then
            
            echo "**✅ Plugin Verification Successful**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| **Plugin Metadata** | ✅ Valid |" >> $GITHUB_STEP_SUMMARY
            echo "| **SLSA Provenance** | ✅ Verified |" >> $GITHUB_STEP_SUMMARY
            echo "| **SBOM Attestation** | ✅ Verified |" >> $GITHUB_STEP_SUMMARY
            echo "| **Vulnerability Scan** | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Verified Artifact:** \`${{ needs.build.outputs.subject-name }}\`" >> $GITHUB_STEP_SUMMARY
            echo "**Trusted Builder:** \`https://github.com/gillisandrew/dragonglass-poc/.github/workflows/buildv2.yml@refs/heads/main\`" >> $GITHUB_STEP_SUMMARY
            
          else
            echo "**❌ Plugin Verification Failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The plugin failed security verification checks. Please review the build logs above for details." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
